---
title: 20 - APIs
theme: "moon"
separator: ---h---
verticalSeparator: ---v---
---

# JEE et APIs

---h---

# APIs : Quelques g√©n√©ralit√©s

---v---

![>icon](img/icons/question.png)

## API = ???

---v---

## Application Programming Interface

---v---

![>icon](img/icons/question.png)

## Qu'est-ce que c'est ?

---v---

> Une API est un ensemble clairement d√©fini de m√©thodes permettant √† diff√©rents composants de communiquer ensemble.

---v---

### ‚ö†Ô∏è Attention ‚ö†Ô∏è

Les APIs ne sont pas uniquement d√©di√©es au web !

Vous en utilisez √©galement pour :

* communiquer avec une base de donn√©es
* interagir avec le syst√®me d'exploitation
* manipuler le hardware
* faire dialoguer des modules logiciels
* ...

---v---

Vous en utilisez d√©j√† !

* Quand vous construisez des applications n-tiers
* Quand vous appelez une d√©pendance externe
* ...

---v---

![>icon](img/icons/question.png)

## On retrouve quoi dans une API ?

---v---

Tout d√©pend du type d'API, mais on retrouvera bien souvent :

* Des m√©thodes
* Des structures de donn√©es
* Des formats de messages
* Des protocoles de communication
* Des codes d'erreur / Exception
* Une gestion de la s√©curit√©

---v---

![>icon](img/icons/question.png)

## Des exemples d'API dans le monde Java ?

---v---

* RMI _(**R**emote **M**ethod **I**nvocation)_
* Corba
* EJB Remote _(bas√©s sur RMI en fait)_

note:

RMI : api d'appel d'objet distant, accessible dans une autre JVM que l'objet appelant

---v---

![>icon](img/icons/question.png)

## Un peu plus √† la mode ?

---v---

* **SOAP** _(**S**imple **O**bject **A**ccess **P**rotocol)_
* **REST** _(**RE**presentational **S**tate **T**ransfer)_

---h---

# SOAP

---v---

## **S**imple **O**bject **A**ccess **P**rotocol

---v---

![>icon](img/icons/question.png)

## C'est quoi ?

---v---

* Protocole d'√©change d'information structur√©e
* Bas√© sur XML
* Permet l'invocation de m√©thodes d'objets distants

---v---

* Contract above HTTP
* M2M Exchange Protocol

note:
Etablissement d'un contrat via le protocole HTTP
Echange machine √† machine

---v---

### Structure

* Une **enveloppe** contenant des informations sur le message
* Un **mod√®le de donn√©es** d√©finissant le format du message

---v---

```xml
<?xml version="1.0"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
soap:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
<soap:Header>
  <!-- ent√™te -->
</soap:Header>
<soap:Body>
  <!-- message -->
    <soap:Fault>
    </soap:Fault>
</soap:Body>
</soap:Envelope>
```
<!-- .element: class="stretch" -->

---v---

### Avantages

* Ouvert √† diff√©rents protocoles de transport
* Ind√©pendant de la plate-forme
* Ind√©pendant du langage
* Extensible
* D√©finition de contrat de service

note:
Autre protocole de transport : SMTP,...

---v---

### Inconv√©nients

* Lourdeur des messages XML
* Couplage fort *(contrat de service)*

---v---

![>icon](img/icons/question.png)

## Quel framework ?

---v---

# JAX-WS

#### Java API for Web Services

---v---

https://cxf.apache.org/


*Probablement le plus populaire en Java*

---v---

# Un contrat ?

---v---

# WSDL

### Web Services Description Language

---v---

```xml
<xsd:element name="getBooks">
    <xsd:complexType>
        <xsd:sequence>
            <xsd:choice>
                <xsd:element name="bookId" type="xsd:long"
                    minOccurs="1"></xsd:element>
                <xsd:element name="bookTitle" type="xsd:string"
                    minOccurs="1"></xsd:element>
                <xsd:element name="authorId" type="xsd:long"
                    minOccurs="1"></xsd:element>
                <xsd:element name="authorName" type="xsd:string"
                    minOccurs="1"></xsd:element>
            </xsd:choice>
        </xsd:sequence>
    </xsd:complexType>
</xsd:element>
```

<!-- .element: class="stretch" -->

note:
Exemple d'une partie du wsdl
Description d'un service web

---v---

### D√©velopper un client

---v---

```shell
wsdl2java -p com.mycompany.greeting Greeting.wsdl
```

---v---

http://cxf.apache.org/docs/wsdl-to-java.html

> wsdl2java - takes a WSDL document and generates fully annotated Java code from which to implement a service.

---v---

```xml
<plugin>
    <groupId>org.apache.cxf</groupId>
    <artifactId>cxf-codegen-plugin</artifactId>
    <version>${cxf.version}</version>
    <executions>
        <execution>
            <id>generate-sources</id>
            <phase>generate-sources</phase>
            <configuration>
                <sourceRoot>${project.build.directory}/generated/cxf</sourceRoot>
                <wsdlOptions>
                    <wsdlOption>
                        <wsdl>${basedir}/src/main/resources/myService.wsdl</wsdl>
                    </wsdlOption>
                </wsdlOptions>
            </configuration>
            <goals>
                <goal>wsdl2java</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

<!-- .element: class="stretch" -->

---v---

http://cxf.apache.org/docs/maven-cxf-codegen-plugin-wsdl-to-java.html

---v---

```java
JaxWsProxyFactoryBean factory = new JaxWsProxyFactoryBean();
factory.setServiceClass(HelloWorld.class);
factory.setAddress("http://localhost:9000/helloWorld");
HelloWorld client = (HelloWorld) factory.create();
String reply = client.sayHi("HI");
System.out.println("Server said: " + reply);
```

---v---

### D√©velopper un service

---v---

Plusieurs fa√ßons d'aborder le d√©veloppement :

* Code Java puis g√©n√©ration de WSDL
* Ecriture du WSDL puis g√©n√©ration du code Java
* Ecriture de XML puis g√©n√©ration du WSDL et Java

---v---

```java
@javax.jws.WebService(
  serviceName = "BookService",
  wsdlLocation = "...",
  endpointInterface = "ili.BookService")
public class BookServiceImpl implements BookService {
    ...
}
```

---v---

- `@WebMethod`
- `@WebParam`
- `@WebResult`

---v---

![>icon](img/icons/tip.png)

## ‚¨áÔ∏è Conclusion ‚¨áÔ∏è

---v---

* Largement utilis√© dans les architectures SOA (*Architecture orient√©e services*)
* Permet la d√©finition de contrat d'interfaces
* Difficile pour les humains
* Lourdeur du XML
* Couplage fort !

note:
SOA: Architecture orient√©e services

---v---

Bref, on va pas faire de TP.

---v---

De rien.

---h---

# REST

---v---

## **RE**presentational **S**tate **T**ransfer

---v---

![>icon](img/icons/question.png)

### C'est quoi ?

---v---

C'est un **style d'architecture**.

note:
bas√© sur des principes

---v---

### D'o√π √ßa vient? üè∫

---v---

### Roy Fielding

![>h](img/20/roy_fielding.jpg)

https://fr.wikipedia.org/wiki/Roy_Fielding

---v---

> Roy Fielding a d√©fini REST en 2000 dans sa th√®se de doctorat Architectural Styles and the Design of Network-based Software Architectures √† l'universit√© de Californie √† Irvine. Il y a d√©velopp√© le style d'architecture REST en parall√®le du protocole HTTP 1.1 de 1996 √† 1999, bas√© sur le mod√®le existant de HTTP 1.0 de 1996.

- source _[wikipedia]_(https://fr.wikipedia.org/wiki/Representational_state_transfer)

---v---

![>icon](img/icons/question.png)

### Restful applications ?

---v---

C'est un terme utilis√© pour une application qui respecte le style d'architecture REST.

---v---

![>icon](img/icons/question.png)

### C'est quoi un style d'architecture ?

---v---

Un ensemble de contraintes et de directives menant au design d'une application et guidant une partie de ses choix techniques.

note: 
- contraintes: RFC (Request For Comments)
- directives: le pluriel dans les URLs

---v---

### REST vs. SOAP

* SOAP & REST :
  * Ind√©pendant de la technologie
  * Repose sur un protocole HTTP
* SOAP :
  * Repose sur XML
  * Contrat fort
  * Difficile pour les humains
* REST :
  * Repose ne definit pas de format precis (HTML, XML, CSV, **JSON** ...)
  * Pas de contrat fort
  * Tests faciles !

note:

en pratique on utilise principalement JSON (pour ses divers avantages) pour REST

---v---

### Le choix d√©pend de vos besoins.

note:

SOAP=tr√®s norm√© et structur√©, assure la s√©curit√©, coh√©rence, atomicit√© des transactions
assure fiabilit√© des transactions
REST=plus souple et plus l√©ger √† mettre en place et √† utiliser

---v---

## Architecture Orient√©e Ressources

---v---

Dans un syst√®me hypermedia, une ressource est **tout ce qui peut √™tre r√©f√©renc√© par un lien**.

note: 
- Hypermedia, an extension of the term hypertext, is a nonlinear medium of information that includes graphics, audio, video, plain text and hyperlinks
- HTTP: Hypertext Transfer Protocol

---v---

## ‚ö†Ô∏è Attention ‚ö†Ô∏è

---v---

Il est important de distinguer une ressource de sa valeur !

---v---

Un exemple ?

* Le *dernier article d'un journal* est une ressource
* Sa valeur diff√®re selon le temps
* La s√©mantique de la ressource elle, ne devra pas changer

note: s√©mantique:
- une ressource sur laquelle je veux agir
- une action (GET, POST, ...)

---v---

Une ressource est identifi√©e par un **identificateur de ressource**.

---v---

![>icon](img/icons/question.png)

## Quel identificateur avec REST ?

---v---

# URI

_**U**niform **R**esource **I**dentifier_

_more info [here](https://fr.wikipedia.org/wiki/Uniform_Resource_Identifier)_

note:
- nom + adresse d'une resource
- A Uniform Resource Identifier (URI) is a unique sequence of characters that identifies a logical or physical resource used by web technologies
- A Uniform Resource Locator (URL), colloquially termed as a web address, is a reference to a web resource that specifies its location on a computer network and a mechanism for retrieving it. A URL is a specific type of Uniform Resource Identifier (URI)
- A URL provides the location of the resource. A URI identifies the resource by name at the specified location or URL

---v---

Les composants de l'architecture manipulent les ressources en transf√©rant des repr√©sentations de ces ressources.

*(HTML, XML, CSV, **JSON**...)*

---v---

## Une interface simple et uniforme

---h---

## **Protocole + Repr√©sentation**

- HTTP + HTML
- HTTP + XML
- HTTP + CSV
- HTTP + **JSON** üëÄ
- HTTP + ...

---h---

![>icon](img/icons/focus.png)

## Repr√©sentation des ressources

# JSON

_**J**ava**S**cript **O**bject **N**otation_

https://www.json.org/json-en.html

---v---

```json
{
  "name": "pikachu",
  "order": 35,
  "species": {
    "name": "pikachu",
    "url": "https://pokeapi.co/api/v2/pokemon-species/25/"
  }
}
```

note: pas sp√©cifiquement de `header` comme en `SOAP` mais le format est libre

---v---

### JSON est ~40% plus l√©ger que XML

---v---

### JSON & Jakarta EE ?

#### JSON-P

> JSON Processing (JSON-P) is a Java API to process (for e.g. parse, generate, transform and query) JSON messages. It produces and consumes JSON text in a streaming fashion (similar to StAX API for XML) and allows to build a Java object model for JSON text using API classes (similar to DOM API for XML).

- source _https://javaee.github.io/jsonp/_
- spec _https://javaee.github.io/jsonb-spec/_

---v---

### JSON-P Object Model calls

```java
public static void main(String[] args) {
   // Create Json and serialize
   JsonObject json = Json.createObjectBuilder()
     .add("name", "Falco")
     .add("age", BigDecimal.valueOf(3))
     .add("biteable", Boolean.FALSE).build();
   String result = json.toString();
     
   System.out.println(result);
 }
```

---v---

### JSON-P Streaming API calls

```java
public static void main(String[] args) {
    // Parse back
    final String result = "{\"name\":\"Falco\",\"age\":3,\"bitable\":false}";
    final JsonParser parser = Json.createParser(new StringReader(result));
    String key = null;
    String value = null;
    while (parser.hasNext()) {
        final Event event = parser.next();
        switch (event) {
        case KEY_NAME:
            key = parser.getString();
            System.out.println(key);
            break;
        case VALUE_STRING:
            value = parser.getString();
            System.out.println(value);
            break;
        }
    }
    parser.close();
}
```

<!-- .element: class="stretch" -->

---v---

![>icon](img/icons/tip.png)

### Un framework pour JSON ?

---v---

## Jackson, par exemple

> Jackson has been known as "the Java JSON library" or "the best JSON parser for Java". Or simply as "JSON for Java".

- source _[github](https://github.com/FasterXML/jackson)_

note:

Librairie pour parser du json ou transformer des objets Java en JSON.

---h---


![>icon](img/icons/focus.png)

## Protocole de communication

# HTTP

_**H**yper**T**ext **T**ransfer **P**rotocol_

https://developer.mozilla.org/en-US/docs/Web/HTTP/Overview

---v---

![>icon](img/icons/question.png)

## Pourquoi HTTP?

---v---

1. URL Complexity
2. HTTP Verbs
3. HTTP Error Codes

---h---

### 1. URL Complexity ?

---v---

`http://exemple.org/maMethode?p1=v1&p2=v2`

---v---

![>icon](img/icons/warning.png)

## Architecture Orient√©e Ressource !

---v---

![>icon](img/icons/question.png)

## De quoi avons-nous besoin ?

---v---

- une s√©mantique (description de l‚Äôinteraction)
- un verbe HTTP (GET, PUT, POST, DELETE, ‚Ä¶)
- une ressource : URI + s√©mantique
- des en-t√™tes de requ√™te (contr√¥le)
- un corps de requ√™te
- des en-t√™te de r√©ponse
- un corps de r√©ponse
- des codes erreurs √©ventuels

---v---

### Exemple

* R√©cup√©rer un article :
  * `JAVA` : `getArticle`
  * Ressource : `GET /articles/123`
* Supprimer un article :
  * `JAVA` : `deleteArticle`
  * Ressource : `DELETE /articles/123`

---v---

### Notez la diff√©rence:

* 2 m√©thodes
* Mais 1 seule ressource
* Avec 2 verbes

---v---

### ‚ö†Ô∏è Attention ‚ö†Ô∏è

Les ressources ne correspondent pas forc√©ment √† vos objets m√©tiers, mais √† tout ce qui peut √™tre identifiable par une URI.

Cela peut √™tre des concepts abstraits.

note:
la m√©teo du jour

---h---

### 2. HTTP Verbs

---v---

![>icon](img/icons/question.png)

## Vous les connaissez ?

---v---

* `GET`: R√©cup√®re la repr√©sentation d'une ressource sp√©cifi√©e
* `POST`: Soumet une entit√© √† la ressource sp√©cifi√©e
* `PUT`: Remplace toutes les repr√©sentations courantes de la ressource sp√©cifi√©e par le _payload_ de la requ√™te
* `DELETE`: Supprime la ressource sp√©cifi√©e

note:

CRUD: **C**reate **R**ead **U**pdate **D**elete
payload: ce qui transporte notre body (contenu)

---v---

### ‚ö†Ô∏è Attention ‚ö†Ô∏è

* Les requ√™tes `GET` doivent seulement **r√©cup√©rer** des donn√©es !
* Les requ√™tes `POST` cause souvent un changement d'√©tat c√¥t√© serveur
* Les requ√™tes `PUT` sont souvent r√©sum√©es √† *mettre √† jour*, alors qu'elles visent en fait √† modifier une **ressource identifi√©e**

note: Notamment pour `GET` qui peut √™tre un gros probl√®me de s√©curit√©

---v---

### PUT vs. POST

On pourrait r√©sumer √† :

* Vous connaissez l'identifiant de la ressource ?
  * `PUT`
* Vous ne connaissez pas l'identifiant de la ressource ?
  * `POST`
* Si l'identifiant unique est g√©n√©r√© par la base de donn√©es par exemple
  * `POST`.

---v---

Le protocole HTTP en defini d'autres mais ils ne sont pas utilis√© dans REST.

* `HEAD`
* `PATCH`
* `CONNECT`
* `OPTIONS`
* `TRACE`

---v---

https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods

---h---

### 3. HTTP Error Codes

---v---

![>icon](img/icons/question.png)

## Vous les connaissez ?

---v---

# 200

### [OK](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/200)

note:

Retourne l'entit√©

---v---

# 201

### [Created](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/201)

note:
Retourne l'entite cr√©√©e
Elle doit avoir √©t√© cr√©√© avant l'envoi de la reponse sinon c'est un 202 : accepted

---v---

# 204

### [No Content](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/204)

---v---

# 301

### [Moved Permanently](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/301)

note:
exemple: proxy, mailing...

---v---

# 400

### [Bad Request](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/400)

note: The server cannot or will not process the request due to something that is perceived to be a client error (e.g., malformed request syntax, invalid request message framing, or deceptive request routing).

---v---

# 403

### [Forbidden](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403)

---v---

# 404

### [Not Found](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/404)

---v---

# 409

### [Conflict](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/409)

### ü§î [GitHub](https://docs.github.com/en/rest/branches/branches?apiVersion=2022-11-28#merge-a-branch)

note: The HTTP 409 Conflict response status code indicates a request conflict with the current state of the target resource.

---v---

# 418

### [I'm a teapot](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/418)

---v---

# 422

### [Unprocessable Entity](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/422)

### ü§î [GitHub](https://docs.github.com/en/rest/repos/contents?apiVersion=2022-11-28#delete-a-file)

note: The request was well-formed but was unable to be followed due to semantic errors.

---v---

# 501

### [Not Implemented](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/501)

---v---

## R√©capitulatif

- **1XX** - Messages techniques
- **2XX** - Succ√®s
- **3XX** - Redirection
- **4XX** - Requ√™te invalide envoy√©e par le client
- **5XX** - Probl√®me serveur

---v---

https://developer.mozilla.org/en-US/docs/Web/HTTP/Status

---h---

# Quelques bonnes pratiques

---v---

### Utilisez le pluriel

- Pr√©f√©rez : `/users/bob`
- Plut√¥t que : `/user/bob`

Rappelez vous que dans `URL`, `R` correspond √† `Resource` et `L` √† `Locator`. Une URL doit donc clairement identifier une ressource.

---v---

Si une ressource `R1` est contenue dans `R2`, l'URL devrait √™tre `R2/{id de R2}/R1/{id de R1}`.

Par exemple :

- `users` : tous les utilisateurs
- `users/bob` : l'utilisateur bob
- `users/bob/friends` : les amis de bob

---v---

### Les retours

- Si vous ne retournez rien, utilisez `204 NO CONTENT` et pas `200 OK`
- Si vous retournez quelque chose, utilisez `200 OK`
- Si vous d√©clenchez un process asynchrone, utilisez `202 ACCEPTED`

---v---

### Les erreurs

En cas d'erreur :

- Si une erreur est survenue a cause des information donnees par le client, utilisez `400 BAD REQUEST`
- Si un probleme est survenue cote serveur, utilisez `500 INTERNAL SERVER ERROR`
- Si vous d√©veloppez un ransomware, utilisez `402 PAYMENT REQUIRED`
- Si le probl√®me concerne l'√©tat d'un objet, utilisez `409 CONFLICT`

Bien entendu, √ßa ne remplace pas les cas identifi√©s type `Unauthorized`, `Not Found`...

---v---

### Les ressources

Une URL doit identifier clairement une ressource.

`/users/bob` : bob doit √™tre l'identifiant unique vers l'utilisateur correspondant.

Pour cr√©er une ressource, faites un POST ou un PUT sur l'URL correspondante. Pas de POST sur des URLs type `/users/create` ou `/users/new`...

---v---

Pour r√©cup√©rer une ressource:

- Faites : `GET /users/bob`
- Et non pas : `GET /users?id=bob`

Pour r√©cup√©rer un ensemble de ressources, utilisez le m√™me path sans identifiant:

- Faites : `GET /users`
- Et non pas : `GET /users/all`

---v---

Pour mettre a jour:

- Faites : `PUT /users/bob`
- Et non pas : `POST /users/bob`

---v---

Et pour supprimer ?

- Faites : `DELETE /users/bob`
- Et non pas : `GET /users/bob/delete`

---h---

# What's next?

![>h whats next](https://media1.giphy.com/media/lPY5d1vUYBreWtF1I0/giphy.gif?cid=ecf05e47z07qnje9y5wmv28mtnh7wpchby5926gyhnojx0tw&ep=v1_gifs_search&rid=giphy.gif&ct=g)

---v---

## More... üëÄ

- https://www.youtube.com/watch?v=vyHpbR6jScI
- https://www.youtube.com/watch?v=7qqzqse1hgc

---v---

## üôÉ TP üôÉ

[TP01](https://github.com/Artmorse/api-rest-tps/tree/tp01)
